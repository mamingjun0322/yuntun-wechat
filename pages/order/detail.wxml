<!--pages/order/detail.wxml-->
<wxs module="utils">
  var formatPrice = function(price) {
    // ä»·æ ¼å·²ç»æ˜¯ä»¥å…ƒä¸ºå•ä½ï¼Œç›´æ¥æ ¼å¼åŒ–å³å¯
    return price.toFixed(2);
  };
  
  module.exports = {
    formatPrice: formatPrice
  };
</wxs>

<view class="detail-container">
  <scroll-view class="detail-content" scroll-y>
    <!-- è®¢å•çŠ¶æ€ -->
    <view class="status-card gradient-bg">
      <view class="status-icon">
        <text wx:if="{{order.status === 1}}">â°</text>
        <text wx:elif="{{order.status === 2}}">ğŸ‘¨â€ğŸ³</text>
        <text wx:elif="{{order.status === 3}}">ğŸšš</text>
        <text wx:elif="{{order.status === 4}}">âœ…</text>
        <text wx:else>âŒ</text>
      </view>
      <text class="status-text">{{getOrderStatusText(order.status)}}</text>
      <text class="status-tip" wx:if="{{order.status === 1}}">è¯·å°½å¿«å®Œæˆæ”¯ä»˜</text>
      <text class="status-tip" wx:elif="{{order.status === 2}}">å•†å®¶æ­£åœ¨åˆ¶ä½œä¸­</text>
      <text class="status-tip" wx:elif="{{order.status === 3}}">éª‘æ‰‹æ­£åœ¨é…é€ä¸­</text>
    </view>

    <!-- é…é€ä¿¡æ¯ï¼ˆå¤–å–ï¼‰ -->
    <view class="info-card card" wx:if="{{order.type === 2}}">
      <view class="card-title">é…é€ä¿¡æ¯</view>
      <view class="info-row">
        <text class="info-label">æ”¶è´§äºº</text>
        <text class="info-value">{{order.receiverName}}</text>
        <text 
          class="phone-btn" 
          bindtap="makePhoneCall"
          data-phone="{{order.receiverPhone}}"
        >
          ğŸ“
        </text>
      </view>
      <view class="info-row">
        <text class="info-label">æ”¶è´§åœ°å€</text>
        <text class="info-value">{{order.address}}</text>
      </view>
      <view class="info-row" wx:if="{{order.deliveryTime}}">
        <text class="info-label">é…é€æ—¶é—´</text>
        <text class="info-value">{{order.deliveryTime}}</text>
      </view>
    </view>

    <!-- å ‚é£Ÿä¿¡æ¯ -->
    <view class="info-card card" wx:if="{{order.type === 1}}">
      <view class="card-title">å ‚é£Ÿä¿¡æ¯</view>
      <view class="info-row">
        <text class="info-label">æ¡Œå·</text>
        <text class="info-value">{{order.tableNo}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">å°±é¤äººæ•°</text>
        <text class="info-value">{{order.peopleCount}}äºº</text>
      </view>
    </view>

    <!-- å•†å“ä¿¡æ¯ -->
    <view class="goods-card card">
      <view class="card-title">å•†å“æ¸…å•</view>
      <view class="goods-list">
        <view class="goods-item" wx:for="{{order.goodsList}}" wx:key="id">
          <image 
            class="goods-image" 
            src="{{handleImageUrl(item.image)}}"
            mode="aspectFill"
          ></image>
          <view class="goods-info">
            <text class="goods-name">{{item.name}}</text>
            <view class="goods-specs" wx:if="{{item.specs && item.specs.length}}">
              <text class="spec-item" wx:for="{{item.specs}}" wx:for-item="spec" wx:key="index">
                {{spec.value}}
              </text>
            </view>
            <view class="goods-bottom">
              <text class="goods-price">Â¥{{utils.formatPrice(item.price)}}</text>
              <text class="goods-quantity">Ã—{{item.quantity}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="order-card card">
      <view class="card-title">è®¢å•ä¿¡æ¯</view>
      <view class="order-row">
        <text class="order-label">è®¢å•ç¼–å·</text>
        <view class="order-value">
          <text class="order-no">{{order.orderNo}}</text>
          <text class="copy-btn" bindtap="copyOrderNo">å¤åˆ¶</text>
        </view>
      </view>
      <view class="order-row">
        <text class="order-label">è®¢å•ç±»å‹</text>
        <text class="order-value">{{getOrderTypeText(order.type)}}</text>
      </view>
      <view class="order-row">
        <text class="order-label">ä¸‹å•æ—¶é—´</text>
        <text class="order-value">{{order.createTime}}</text>
      </view>
      <view class="order-row" wx:if="{{order.remark}}">
        <text class="order-label">è®¢å•å¤‡æ³¨</text>
        <text class="order-value">{{order.remark}}</text>
      </view>
    </view>

    <!-- è´¹ç”¨æ˜ç»† -->
    <view class="amount-card card">
      <view class="card-title">è´¹ç”¨æ˜ç»†</view>
      <view class="amount-row">
        <text class="amount-label">å•†å“æ€»é¢</text>
        <text class="amount-value">Â¥{{utils.formatPrice(order.goodsAmount)}}</text>
      </view>
      <view class="amount-row" wx:if="{{order.type === 2 && order.deliveryFee}}">
        <text class="amount-label">é…é€è´¹</text>
        <text class="amount-value">Â¥{{utils.formatPrice(order.deliveryFee)}}</text>
      </view>
      <view class="amount-row" wx:if="{{order.type === 2 && order.packingFee}}">
        <text class="amount-label">æ‰“åŒ…è´¹</text>
        <text class="amount-value">Â¥{{utils.formatPrice(order.packingFee)}}</text>
      </view>
      <view class="amount-row" wx:if="{{order.couponDiscount > 0}}">
        <text class="amount-label">ä¼˜æƒ åˆ¸</text>
        <text class="amount-value discount">-Â¥{{utils.formatPrice(order.couponDiscount)}}</text>
      </view>
      <view class="amount-row total-row">
        <text class="amount-label total-label">å®ä»˜æ¬¾</text>
        <text class="amount-value total-value">Â¥{{utils.formatPrice(order.totalAmount)}}</text>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar safe-area-inset-bottom" wx:if="{{order.status}}">
    <!-- å¾…æ”¯ä»˜ -->
    <block wx:if="{{order.status === 1}}">
      <view class="bar-btn plain-btn" bindtap="cancelOrder">å–æ¶ˆè®¢å•</view>
      <view class="bar-btn primary-btn" bindtap="goPay">å»æ”¯ä»˜</view>
    </block>

    <!-- é…é€ä¸­ -->
    <block wx:if="{{order.status === 3 && order.type === 2}}">
      <view class="bar-btn primary-btn" bindtap="confirmReceipt">ç¡®è®¤æ”¶è´§</view>
    </block>

    <!-- å·²å®Œæˆ -->
    <block wx:if="{{order.status === 4}}">
      <view class="bar-btn plain-btn" bindtap="orderAgain">å†æ¥ä¸€å•</view>
      <view class="bar-btn primary-btn" wx:if="{{!order.commented}}" bindtap="goComment">å»è¯„ä»·</view>
    </block>

    <!-- å·²å–æ¶ˆ -->
    <block wx:if="{{order.status === 5}}">
      <view class="bar-btn disabled-btn">è®¢å•å·²å–æ¶ˆ</view>
    </block>
  </view>
</view>
