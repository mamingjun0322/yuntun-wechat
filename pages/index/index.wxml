<!--pages/index/index.wxml-->
<wxs module="utils">
  var formatPrice = function(price) {
    // ä»·æ ¼å·²ç»æ˜¯ä»¥å…ƒä¸ºå•ä½ï¼Œç›´æ¥æ ¼å¼åŒ–å³å¯
    return price.toFixed(2);
  };
  
  module.exports = {
    formatPrice: formatPrice
  };
</wxs>

<view class="page-container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-navbar" style="padding-top: {{statusBarHeight}}px;">
    <view class="navbar-content">
      <view class="location">
        <text class="icon">ğŸ“</text>
        <text class="location-text">{{shopInfo.name || 'åŠ è½½ä¸­...'}}</text>
      </view>
      <view class="search-box" bindtap="goSearch">
        <text class="search-icon">ğŸ”</text>
        <text class="search-placeholder">æœç´¢å•†å“</text>
      </view>
    </view>
  </view>
  
  <!-- è½®æ’­å›¾ -->
  <view class="banner-section" wx:if="{{bannerList.length}}">
    <swiper class="banner-swiper" autoplay circular indicator-dots indicator-color="rgba(255,255,255,0.5)" indicator-active-color="#fff">
      <swiper-item wx:for="{{bannerList}}" wx:key="id" bindtap="onBannerTap" data-url="{{item.url}}">
        <image 
          class="banner-image" 
          src="{{handleImageUrl(item.image)}}" 
          mode="aspectFill"
        ></image>
      </swiper-item>
    </swiper>
  </view>
  
  <!-- åˆ†ç±»å¯¼èˆª -->
  <view class="category-section" wx:if="{{categoryList.length}}">
    <scroll-view class="category-scroll" scroll-x>
      <view 
        class="category-item {{currentCategory === 0 ? 'active' : ''}}"
        bindtap="selectCategory"
        data-id="{{0}}"
      >
        <text class="category-name">å…¨éƒ¨</text>
      </view>
      <view 
        class="category-item {{currentCategory === item.id ? 'active' : ''}}"
        wx:for="{{categoryList}}" 
        wx:key="id"
        bindtap="selectCategory"
        data-id="{{item.id}}"
      >
        <text class="category-name">{{item.name}}</text>
      </view>
    </scroll-view>
  </view>
  
  <!-- å•†å“åˆ—è¡¨ -->
  <view class="goods-section">
    <view class="goods-list">
      <view 
        class="goods-item" 
        wx:for="{{goodsList}}" 
        wx:key="id"
        bindtap="goGoodsDetail"
        data-id="{{item.id}}"
      >
        <image 
          class="goods-image" 
          src="{{handleImageUrl(item.image)}}" 
          mode="aspectFill"
        ></image>
        <view class="goods-info">
          <text class="goods-name">{{item.name}}</text>
          <text class="goods-desc">{{item.description}}</text>
          <view class="goods-footer">
            <view class="price-box">
              <text class="price-symbol">Â¥</text>
              <text class="price-value">{{utils.formatPrice(item.price)}}</text>
              <text class="original-price" wx:if="{{item.originalPrice}}">
                Â¥{{utils.formatPrice(item.originalPrice)}}
              </text>
            </view>
            
            <!-- æœªæ·»åŠ æ—¶æ˜¾ç¤ºåŠ å· -->
            <view 
              class="add-btn" 
              catchtap="addToCart"
              data-goods="{{item}}"
              wx:if="{{!item.cartQuantity || item.cartQuantity === 0}}"
            >
              <text class="add-icon">+</text>
            </view>
            
            <!-- å·²æ·»åŠ æ—¶æ˜¾ç¤ºæ•°é‡æ§åˆ¶å™¨ -->
            <view class="goods-quantity-control" wx:else>
              <view 
                class="quantity-btn minus" 
                catchtap="decreaseGoods"
                data-id="{{item.id}}"
              >
                <text class="btn-icon">-</text>
              </view>
              <text class="quantity-text">{{item.cartQuantity}}</text>
              <view 
                class="quantity-btn plus" 
                catchtap="increaseGoods"
                data-id="{{item.id}}"
              >
                <text class="btn-icon">+</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="load-more" wx:if="{{goodsList.length}}">
      <text class="load-text" wx:if="{{!noMore}}">åŠ è½½æ›´å¤š...</text>
      <text class="load-text" wx:else>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && !goodsList.length}}">
      <text class="empty-icon">ğŸ±</text>
      <text class="empty-text">æš‚æ— å•†å“</text>
    </view>
  </view>

  <!-- æµ®åŠ¨è´­ç‰©è½¦æŒ‰é’® -->
  <view class="cart-float-btn" bindtap="showCartDrawer" wx:if="{{cartList.length}}">
    <text class="cart-icon">ğŸ›’</text>
    <view class="cart-badge" wx:if="{{cartTotalQuantity > 0}}">{{cartTotalQuantity}}</view>
  </view>

  <!-- è´­ç‰©è½¦æŠ½å±‰ -->
  <view class="cart-drawer {{showCart ? 'show' : ''}}" wx:if="{{showCart}}">
    <view class="drawer-mask" bindtap="hideCartDrawer"></view>
    <view class="drawer-content">
      <!-- æŠ½å±‰å¤´éƒ¨ -->
      <view class="drawer-header">
        <text class="drawer-title">è´­ç‰©è½¦ ({{cartList.length}})</text>
        <view class="drawer-actions">
          <text class="clear-btn" bindtap="clearCart" wx:if="{{cartList.length}}">æ¸…ç©º</text>
          <text class="close-btn" bindtap="hideCartDrawer">âœ•</text>
        </view>
      </view>

      <!-- è´­ç‰©è½¦åˆ—è¡¨ -->
      <scroll-view class="drawer-body" scroll-y wx:if="{{cartList.length}}">
        <view class="cart-item" wx:for="{{cartList}}" wx:key="index">
          <!-- é€‰æ‹©æ¡† -->
          <view 
            class="checkbox {{item.selected ? 'checked' : ''}}"
            bindtap="toggleCartSelect"
            data-index="{{index}}"
          >
            <text class="check-icon" wx:if="{{item.selected}}">âœ“</text>
          </view>

          <!-- å•†å“ä¿¡æ¯ -->
          <image 
            class="cart-goods-image" 
            src="{{handleImageUrl(item.image)}}" 
            mode="aspectFill"
          ></image>

          <view class="cart-goods-info">
            <view class="cart-goods-name">{{item.name}}</view>
            
            <!-- è§„æ ¼ -->
            <view class="cart-goods-specs" wx:if="{{item.specs && Object.keys(item.specs).length}}">
              <text 
                class="spec-item" 
                wx:for="{{Object.keys(item.specs)}}" 
                wx:for-item="key"
                wx:key="key"
              >
                {{item.specs[key].value}}
              </text>
            </view>

            <view class="cart-goods-footer">
              <view class="cart-price">
                <text class="price-symbol">Â¥</text>
                <text class="price-value">{{utils.formatPrice(item.price)}}</text>
              </view>

              <!-- æ•°é‡æ§åˆ¶ -->
              <view class="cart-quantity-control">
                <view 
                  class="cart-control-btn" 
                  bindtap="decreaseCartQuantity"
                  data-index="{{index}}"
                >
                  -
                </view>
                <view class="cart-quantity-value">{{item.quantity}}</view>
                <view 
                  class="cart-control-btn" 
                  bindtap="increaseCartQuantity"
                  data-index="{{index}}"
                >
                  +
                </view>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- ç©ºè´­ç‰©è½¦ -->
      <view class="drawer-empty" wx:else>
        <text class="empty-icon">ğŸ›’</text>
        <text class="empty-text">è´­ç‰©è½¦æ˜¯ç©ºçš„</text>
      </view>

      <!-- åº•éƒ¨ç»“ç®—æ  -->
      <view class="drawer-footer" wx:if="{{cartList.length}}">
        <view class="footer-left">
          <!-- å…¨é€‰ -->
          <view class="select-all" bindtap="toggleCartSelectAll">
            <view class="checkbox {{cartAllSelected ? 'checked' : ''}}">
              <text class="check-icon" wx:if="{{cartAllSelected}}">âœ“</text>
            </view>
            <text class="select-text">å…¨é€‰</text>
          </view>

          <!-- åˆè®¡ -->
          <view class="total-info">
            <text class="total-label">åˆè®¡ï¼š</text>
            <text class="total-symbol">Â¥</text>
            <text class="total-value">{{utils.formatPrice(cartTotalPrice)}}</text>
          </view>
        </view>

        <!-- ç»“ç®—æŒ‰é’® -->
        <view 
          class="cart-checkout-btn {{cartTotalQuantity > 0 ? 'active' : ''}}" 
          bindtap="cartCheckout"
        >
          ç»“ç®—({{cartTotalQuantity}})
        </view>
      </view>
    </view>
  </view>
</view>
